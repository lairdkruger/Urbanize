<html>
    <head>
        <meta charset="utf-8">
        <title>Urbanize Visualizer</title>
        
        <script src="src/canvas.js"></script>
        <script src="src/creative_coding.js"></script>
        <script src="src/mic.js"></script>
        
    </head>
    
    <body>
        
        <script>
            //create canvas
            var ctx = createCanvas("canvas1");
            
            //double click fullscreen event listener
            //Double Click to go FULLSCREEN
            function getreqfullscreen(){
                var root = document.documentElement
                return root.requestFullscreen || root.webkitRequestFullscreen || root.mozRequestFullScreen || root.msRequestFullscreen
            }
            
            canvas.addEventListener('dblclick', function(){ 

                //usage: getreqfullscreen().call(targetelement) // open full screen on targetelement
            
                var globalreqfullscreen = getreqfullscreen() // get supported version of requestFullscreen()
            
                globalreqfullscreen.call(document.documentElement);
            });
            

            //set to 128 for digitised effect, otherwise 512 is smooth
            var mic = new Microphone(512);
            
            //particles
            var left_particles = [];
            var right_particles = [];
            var num_particles = 74;
            var radius = 300;
    
            //colours
            //var line_colour = rgb(250, 0, 0);
            var line_colour = rgb(255, 255, 255);
            var gradient = ctx.createRadialGradient(w/2, h/2, w/2, w/2, h/2, w/4);
            gradient.addColorStop(1, rgb(230, 230, 230));
            gradient.addColorStop(0, rgb(255, 255, 255));
            
            
            //add a number of particles to particles
            for (i = 0; i < num_particles; i++) {
                addLeftParticle(i);
                addRightParticle(i);
            }
            
            
            function addLeftParticle(_i) {
                var _angle = radians(halfDistributeAngles(i, num_particles)) + Math.PI/2;
                var particle = {
                    x: 0,
                    y: 0,
                    angle: _angle,
                    radius: radius,
                    intensity: 1
                }
                left_particles.push(particle);
            }
            
            
            //creates a particle object and adds it to the particles object
            function addRightParticle(_i) {
                var _angle = radians(halfDistributeAngles(i, num_particles)) + Math.PI/2 + 0.026;
                var particle = {
                    x: 0,
                    y: 0,
                    angle: _angle,
                    radius: radius,
                    intensity: 1
                }
                right_particles.push(particle);
            }
            
            
            function drawParticles(explode) {
                for (i = 0; i < num_particles; i++) {
                    
                    waveform = mic.mapWaveform(i, num_particles, 1, h/2);
                    
                    pl = left_particles[i];
                    //optional
                    //pl.radius = mic.getRMS(mic.spectrum) * 4;
                    pl.intensity = pl.radius * waveform * explode;
                    pl.x = w/2 + Math.cos(pl.angle) * (radius) + 4.2;
                    pl.y = h/2 + Math.sin(pl.angle) * (radius);
                    
                    pr = right_particles[i];
                    //optional
                    //pr.radius = mic.getRMS(mic.spectrum) * 4;
                    pr.x = w - (w/2 + Math.cos(pr.angle) * (radius)) - 4.2;
                    pr.y = h/2 + Math.sin(pr.angle) * (radius);
                }
            }
            
            
            function drawConnections () {
                for (i = 0; i < num_particles - 1; i++) {
                    pl1 = left_particles[i];
                    pl2 = left_particles[i + 1];
                    pr1 = right_particles[i];
                    pr2 = right_particles[i + 1];
                    
                    waveform = mic.mapWaveform(i, num_particles, 1, h * 3);
                    ctx.lineWidth = (50 * waveform) * line_width;
                    
                    ctx.line(pl1.x, pl1.y, pl2.x, pl2.y);
                    ctx.line(pr1.x, pr1.y, pr2.x, pr2.y);
                }
            }
                
            
            //requests animation frame
            function draw(){
                frameRate = 120;
                  
                if (mic.getRMS(mic.spectrum) > mic.peak_volume - 20) {
                    line_width = 2;
                    ctx.strokeStyle = rgb(0);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, w, h);
                    //set to 2 for bigger explosion
                    //drawParticles(2);
                } else {
                    line_width = 1;
                    ctx.strokeStyle = line_colour;
                    ctx.background(0, map(mic.getRMS(mic.spectrum), 0, 100, 0.25, 0.1));
                    //drawParticles(1);
                }
                
                drawParticles(1);
                drawConnections();
            }
            
        </script>
    </body>
</html>